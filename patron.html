<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resultado DISC - Patrón</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 40px 20px;
      background: linear-gradient(90deg, #a8e6cf 0%, #b8e6d3 25%, #c8e6d7 50%, #d4e8e0 75%, #e0eae9 100%);
      min-height: 100vh;
      color: #222;
      line-height: 1.6;
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
    }
    .container {
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      max-width: 800px;
      width: 100%;
      margin: auto;
      backdrop-filter: blur(10px);
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      color: #2c2c2c;
      font-size: 2.5em;
      margin-bottom: 30px;
      font-weight: 600;
    }
    h2 {
      color: #5fa890;
      margin-top: 30px;
      margin-bottom: 10px;
      font-size: 1.4em;
      border-left: 4px solid #7fb8a3;
      padding-left: 15px;
    }
    p {
      margin-bottom: 15px;
      color: #444;
    }
    .meta {
      margin-top: 30px;
      margin-bottom: 20px;
      font-style: italic;
      padding: 15px;
      background: linear-gradient(135deg, #f0f9f5, #ffffff);
      border-radius: 10px;
      border-left: 4px solid #7fb8a3;
    }
    code {
      background: #f0f9f5;
      padding: 2px 6px;
      border-radius: 4px;
      color: #5fa890;
      font-family: 'Courier New', monospace;
    }
    .email-form {
      margin-top: 40px;
      padding: 30px;
      background: linear-gradient(135deg, #f0f9f5, #ffffff);
      border-radius: 15px;
      border-left: 4px solid #7fb8a3;
    }
    .email-form h2 {
      margin-top: 0;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #2c2c2c;
      font-weight: 500;
    }
    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #d4e8e0;
      border-radius: 8px;
      font-size: 16px;
      font-family: "Segoe UI", sans-serif;
      transition: border-color 0.3s;
    }
    .form-group input:focus {
      outline: none;
      border-color: #5fa890;
    }
    .btn-send {
      background: linear-gradient(135deg, #5fa890, #7fb8a3);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
    }
    .btn-send:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(95, 168, 144, 0.3);
    }
    .btn-send:active {
      transform: translateY(0);
    }
    .btn-send:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .message {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      display: none;
    }
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      body {
        padding: 20px 10px;
      }
      
      .container {
        padding: 25px 20px;
        border-radius: 15px;
      }
      
      h1 {
        font-size: 1.8em;
        margin-bottom: 20px;
      }
      
      h2 {
        font-size: 1.2em;
        margin-top: 25px;
        padding-left: 12px;
      }
      
      p {
        font-size: 0.95em;
        margin-bottom: 12px;
      }
      
      .logo-header {
        margin-bottom: 20px;
      }
      
      .logo-header div {
        width: 100px !important;
        height: 100px !important;
      }
      
      .email-form {
        margin-top: 30px;
        padding: 20px;
      }
      
      .email-form h2 {
        font-size: 1.2em;
      }
      
      .form-group input {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 14px 15px;
        -webkit-appearance: none;
        appearance: none;
      }
      
      .btn-send {
        padding: 14px 20px;
        font-size: 15px;
        min-height: 48px; /* Touch-friendly button size */
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }
      
      .meta {
        padding: 12px;
        font-size: 0.9em;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 15px 8px;
      }
      
      .container {
        padding: 20px 15px;
        border-radius: 12px;
      }
      
      h1 {
        font-size: 1.5em;
        margin-bottom: 15px;
        line-height: 1.3;
      }
      
      h2 {
        font-size: 1.1em;
        margin-top: 20px;
        margin-bottom: 8px;
        padding-left: 10px;
        border-left-width: 3px;
      }
      
      p {
        font-size: 0.9em;
        margin-bottom: 10px;
        line-height: 1.5;
      }
      
      .logo-header {
        margin-bottom: 15px;
      }
      
      .logo-header div {
        width: 80px !important;
        height: 80px !important;
      }
      
      .email-form {
        margin-top: 25px;
        padding: 15px;
      }
      
      .email-form h2 {
        font-size: 1.1em;
        margin-top: 0;
      }
      
      .email-form p {
        font-size: 0.9em;
        margin-bottom: 15px;
      }
      
      .form-group {
        margin-bottom: 15px;
      }
      
      .form-group label {
        font-size: 0.95em;
        margin-bottom: 6px;
      }
      
      .form-group input {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 12px 12px;
        -webkit-appearance: none;
        appearance: none;
      }
      
      .btn-send {
        padding: 14px 15px;
        font-size: 14px;
        min-height: 48px;
        letter-spacing: 0.5px;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }
      
      .message {
        padding: 10px;
        font-size: 0.9em;
      }
      
      .meta {
        padding: 10px;
        font-size: 0.85em;
        margin-top: 20px;
        margin-bottom: 15px;
      }
      
      code {
        font-size: 0.85em;
        padding: 2px 4px;
        word-break: break-word;
      }
    }

    /* Prevent text overflow on very small screens */
    @media (max-width: 360px) {
      h1 {
        font-size: 1.3em;
      }
      
      h2 {
        font-size: 1em;
      }
      
      p {
        font-size: 0.85em;
      }
      
      .container {
        padding: 15px 12px;
      }
    }
  </style>
  <link rel="stylesheet" href="results.css" />
  <!-- EmailJS SDK -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
  <!-- Encabezado con el logo SVG del index.html -->
  <header class="logo-header" style="text-align: center; margin-bottom: 30px;">
    <div style="display: inline-block; width: 140px; height: 140px;">
      <svg class="logo-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: 100%;">
        <defs>
          <path id="arc-path" d="M 100,30 A 70,70 0 1,1 100,170"/>
          <path id="arc-path-top" d="M 140,50 Q 100,30 60,50"/>
          <path id="arc-path-bottom" d="M 60,150 Q 100,170 140,150"/>
        </defs>
        
        <!-- Circular arc -->
        <path d="M 100,30 A 70,70 0 1,1 100,170" 
              stroke="#2c2c2c" 
              stroke-width="6" 
              fill="none" 
              stroke-linecap="round"/>
        
        <!-- Stars -->
        <g transform="translate(70,50)">
          <polygon points="0,-4 1,-1 4,-1 1.5,1 2.5,4 0,2 -2.5,4 -1.5,1 -4,-1 -1,-1" fill="#2c2c2c"/>
        </g>
        <g transform="translate(130,150)">
          <polygon points="0,-4 1,-1 4,-1 1.5,1 2.5,4 0,2 -2.5,4 -1.5,1 -4,-1 -1,-1" fill="#2c2c2c"/>
        </g>

        <!-- Dots -->
        <circle cx="115" cy="45" r="2" fill="#2c2c2c"/>
        <circle cx="85" cy="55" r="1.5" fill="#2c2c2c"/>
        <circle cx="125" cy="75" r="1.5" fill="#2c2c2c"/>
        <circle cx="75" cy="85" r="1.5" fill="#2c2c2c"/>
        <circle cx="130" cy="110" r="1.5" fill="#2c2c2c"/>
        <circle cx="70" cy="115" r="1.5" fill="#2c2c2c"/>
        <circle cx="125" cy="145" r="1.5" fill="#2c2c2c"/>
        <circle cx="75" cy="155" r="1.5" fill="#2c2c2c"/>
        <circle cx="120" cy="60" r="1" fill="#2c2c2c"/>
        <circle cx="80" cy="70" r="1" fill="#2c2c2c"/>
        <circle cx="135" cy="95" r="1" fill="#2c2c2c"/>
        <circle cx="65" cy="100" r="1" fill="#2c2c2c"/>
        <circle cx="135" cy="125" r="1" fill="#2c2c2c"/>
        <circle cx="65" cy="130" r="1" fill="#2c2c2c"/>

        <!-- Text -->
        <text x="100" y="50" text-anchor="middle" font-family="Brush Script MT, Lucida Handwriting, cursive" font-size="18" font-weight="600" fill="#2c2c2c">Onboarding</text>
        <text x="88" y="105" text-anchor="middle" font-family="Brush Script MT, Lucida Handwriting, cursive" font-size="48" font-weight="700" fill="#2c2c2c">O</text>
        <text x="112" y="105" text-anchor="middle" font-family="Brush Script MT, Lucida Handwriting, cursive" font-size="48" font-weight="700" fill="#2c2c2c">B</text>
        <text x="100" y="160" text-anchor="middle" font-family="Brush Script MT, Lucida Handwriting, cursive" font-size="10" fill="#2c2c2c">Global skills for job positioning</text>
      </svg>
    </div>
  </header>

  <div class="container">
    <h1 id="nombre">Patrón del Alentador</h1>

    <h2>Descripción:</h2>
    <p id="descripcion"></p>

    <h2>Nivel de Onboarding:</h2>
    <p id="nivel_onboarding" style="white-space: pre-line;"></p>

    <h2>Aprendizajes esperados:</h2>
    <p id="aprendizajes_esperados" style="white-space: pre-line;"></p>

    <!-- Email Form -->
    <div class="email-form">
      <h2>Recibir resultados por correo</h2>
      <p style="margin-bottom: 20px;">Ingresa tu correo electrónico para recibir tus resultados del test DISC:</p>
      <form id="emailForm">
        <div class="form-group">
          <label for="userEmail">Correo electrónico:</label>
          <input 
            type="email" 
            id="userEmail" 
            name="userEmail" 
            placeholder="tu@email.com" 
            required
          />
        </div>
        <button type="submit" class="btn-send" id="sendBtn">
          Enviar resultados por correo
        </button>
        <div id="message" class="message"></div>
      </form>
    </div>
  </div>

  <script src="patrones.js"></script>
  <script>
    // Función para calcular segmentos desde los resultados (fallback)
    function calculateSegmentsFromResults() {
      try {
        // Intentar obtener resultados de múltiples fuentes
        let resultsStr = null;
        
        // 1. Intentar de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const resultsParam = urlParams.get("results");
        if (resultsParam) {
          resultsStr = decodeURIComponent(resultsParam);
          console.log("discResults obtenidos de la URL");
        }
        
        // 2. Intentar de sessionStorage
        if (!resultsStr) {
          resultsStr = sessionStorage.getItem("discResults");
          if (resultsStr) {
            console.log("discResults obtenidos de sessionStorage");
          }
        }
        
        // 3. Intentar de localStorage
        if (!resultsStr) {
          resultsStr = localStorage.getItem("discResults");
          if (resultsStr) {
            console.log("discResults obtenidos de localStorage");
          }
        }
        
        console.log("discResults encontrados:", resultsStr);
        
        if (!resultsStr) {
          console.error("No se encontró discResults en ninguna fuente");
          return null;
        }

        const results = JSON.parse(resultsStr);
        console.log("Resultados parseados:", results);
        
        // Verificar que los resultados tengan las propiedades necesarias
        if (!results || typeof results.D === 'undefined' || typeof results.I === 'undefined' || 
            typeof results.S === 'undefined' || typeof results.C === 'undefined') {
          console.error("Los resultados no tienen las propiedades D, I, S, C:", results);
          return null;
        }

        const displayOffset = { D: -4, I: -4, S: -5, C: -4 };
        
        const displayScores = {
          D: results.D + displayOffset.D,
          I: results.I + displayOffset.I,
          S: results.S + displayOffset.S,
          C: results.C + displayOffset.C
        };
        
        console.log("Display scores calculados:", displayScores);

        // Copiar las funciones de cálculo de segmentos desde disc.js
        const scoreToIntensityMap = {
          D: {
            28: 28, 27: 12, 26: null, 25: 9, 24: 8, 23: 7, 22: 6, 21: 5, 20: 4,
            19: 3, 18: null, 17: 2, 16: 1, 15: 0, 14: 0, 13: null, 12: -1,
            11: -2, 10: null, 9: -3, 8: -4, 7: -5, 6: -6, 5: -7, 4: -8,
            3: null, 2: -11, 1: -28
          },
          I: {
            28: 28, 27: 10, 26: null, 25: 7, 24: 6, 23: 5, 22: 4, 21: null, 20: 3,
            19: null, 18: 2, 17: null, 16: 1, 15: 0, 14: null, 13: -1, 12: -2,
            11: null, 10: -3, 9: null, 8: -4, 7: -5, 6: -6, 5: -7, 4: -8,
            3: null, 2: -11, 1: -28
          },
          S: {
            28: 28, 27: 10, 26: null, 25: 8, 24: 7, 23: 6, 22: 4, 21: 3, 20: 2,
            19: 1, 18: null, 17: 0, 16: -1, 15: -2, 14: null, 13: -3, 12: -4,
            11: -5, 10: null, 9: -6, 8: -7, 7: -8, 6: -9, 5: -10, 4: -11,
            3: null, 2: -13, 1: -28
          },
          C: {
            28: 28, 27: 11, 26: null, 25: 9, 24: 8, 23: 7, 22: 6, 21: 5, 20: 4,
            19: null, 18: 3, 17: null, 16: 2, 15: 1, 14: null, 13: 0, 12: -1,
            11: null, 10: -2, 9: null, 8: -3, 7: -4, 6: null, 5: -5, 4: -6,
            3: null, 2: -11, 1: -28
          }
        };

        function getIntensityFromScore(score, type) {
          const map = scoreToIntensityMap[type];
          if (!map) return 15;

          let closestIntensity = 15;
          let minDiff = Infinity;

          for (const [intensity, mappedScore] of Object.entries(map)) {
            if (mappedScore === null) continue;
            const diff = Math.abs(mappedScore - score);
            if (diff < minDiff) {
              minDiff = diff;
              closestIntensity = parseInt(intensity);
            }
            if (mappedScore === score) return parseInt(intensity);
          }

          return closestIntensity;
        }

        function getSegmentFromIntensity(intensity, type) {
          const map = {
            D: {
              28: 7, 27: 7, 26: 7, 25: 7,
              24: 6, 23: 6, 22: 6, 21: 6, 
              20: 5, 19: 5, 18: 5, 17: 5,
              16: 4, 15: 4, 14: 4, 13: 4,
              12: 3, 11: 3, 10: 3, 9: 3,
              8: 2, 7: 2, 6: 2, 5: 2,
              4: 1, 3: 1, 2: 1, 1: 1
            },
            I: {
              28: 7, 27: 7, 26: 6, 25: 7,
              24: 6, 23: 6, 22: 6, 21: 6, 
              20: 5, 19: 5, 18: 5, 17: 5,
              16: 4, 15: 4, 14: 4, 13: 4,
              12: 3, 11: 3, 10: 3, 9: 3,
              8: 2, 7: 2, 6: 2, 5: 2,
              4: 1, 3: 1, 2: 1, 1: 1
            },
            S: {
              28: 7, 27: 7, 26: 6, 25: 7,
              24: 6, 23: 6, 22: 6, 21: 6, 
              20: 5, 19: 5, 18: 5, 17: 5,
              16: 4, 15: 4, 14: 4, 13: 4,
              12: 3, 11: 3, 10: 3, 9: 3,
              8: 2, 7: 2, 6: 2, 5: 2,
              4: 1, 3: 1, 2: 1, 1: 1
            },
            C: {
              28: 7, 27: 7, 26: 6, 25: 7,
              24: 6, 23: 6, 22: 6, 21: 6, 
              20: 5, 19: 5, 18: 5, 17: 5,
              16: 4, 15: 4, 14: 4, 13: 4,
              12: 3, 11: 3, 10: 3, 9: 3,
              8: 2, 7: 2, 6: 2, 5: 2,
              4: 1, 3: 1, 2: 1, 1: 1
            }
          };
          return map[type]?.[intensity] ?? 1;
        }

        function getSegmentFromScore(score, type) {
          const intensity = getIntensityFromScore(score, type);
          const segment = getSegmentFromIntensity(intensity, type);
          console.log(`  ${type}: score=${score}, intensity=${intensity}, segment=${segment}`);
          return segment;
        }

        const segments = {
          D: getSegmentFromScore(displayScores.D, 'D'),
          I: getSegmentFromScore(displayScores.I, 'I'),
          S: getSegmentFromScore(displayScores.S, 'S'),
          C: getSegmentFromScore(displayScores.C, 'C')
        };
        
        console.log("Segmentos calculados exitosamente:", segments);
        return segments;
      } catch (error) {
        console.error("Error calculando segmentos:", error);
        console.error("Stack trace:", error.stack);
        return null;
      }
    }

    // Función para buscar el patrón según el código de 4 dígitos
    function findPatronByCode(code) {
      if (!window.patrones || !Array.isArray(window.patrones)) {
        console.error("No se encontraron patrones o no es un array");
        return null;
      }

      console.log("Buscando código:", code, "en", window.patrones.length, "patrones");

      // Buscar en cada patrón si el código está en su lista de códigos
      for (let i = 0; i < window.patrones.length; i++) {
        const patron = window.patrones[i];
        if (patron && patron.codigo) {
          // Dividir los códigos por comas y espacios, y buscar coincidencia exacta
          const codigos = patron.codigo.split(/[,\s]+/).filter(c => c.trim() !== '');
          
          // Debug: mostrar algunos códigos del primer patrón para verificar
          if (i === 0 && codigos.length > 0) {
            console.log("Ejemplo de códigos del primer patrón (primeros 5):", codigos.slice(0, 5));
          }
          
          if (codigos.includes(code)) {
            console.log("✓ Patrón encontrado en índice", i, ":", patron.nombre);
            console.log("  Código buscado:", code, "coincide con uno de los códigos del patrón");
            return patron;
          }
        }
      }
      
      console.log("✗ No se encontró patrón para código:", code);
      console.log("  Verificando códigos disponibles en los primeros 3 patrones...");
      for (let i = 0; i < Math.min(3, window.patrones.length); i++) {
        const patron = window.patrones[i];
        if (patron && patron.codigo) {
          const codigos = patron.codigo.split(/[,\s]+/).filter(c => c.trim() !== '').slice(0, 10);
          console.log(`  Patrón ${i + 1} (${patron.nombre}): primeros códigos:`, codigos.join(", "));
        }
      }
      return null;
    }

    // Obtener los segmentos de localStorage o calcularlos
    function loadPatron() {
      try {
        // Verificar si localStorage está disponible
        if (typeof(Storage) === "undefined") {
          throw new Error("localStorage no está disponible en este navegador.");
        }
        
        // Verificar el protocolo
        console.log("Protocolo actual:", window.location.protocol);
        if (window.location.protocol === "file:") {
          console.warn("Advertencia: Se está usando el protocolo file://. Algunos navegadores pueden tener restricciones con localStorage.");
        }
        
        // Esperar a que patrones.js se cargue
        if (!window.patrones) {
          console.log("Esperando a que se cargue patrones.js...");
          setTimeout(loadPatron, 100);
          return;
        }

        // Listar todas las claves en localStorage para debug
        console.log("Todas las claves en localStorage:", Object.keys(localStorage));
        console.log("Todas las claves en sessionStorage:", Object.keys(sessionStorage || {}));
        
        let segments = null;
        
        // 1. Intentar leer de los parámetros de la URL primero (más confiable con file://)
        const urlParams = new URLSearchParams(window.location.search);
        const segmentsParam = urlParams.get("segments");
        if (segmentsParam) {
          try {
            segments = JSON.parse(decodeURIComponent(segmentsParam));
            console.log("✓ Segmentos obtenidos de la URL:", segments);
            // Store segments globally for email functionality
            window.currentSegments = segments;
            // Guardar en localStorage y sessionStorage para futuras referencias
            try {
              localStorage.setItem("discSegments", JSON.stringify(segments));
              sessionStorage.setItem("discSegments", JSON.stringify(segments));
            } catch (e) {
              console.warn("No se pudieron guardar los segmentos:", e);
            }
          } catch (e) {
            console.error("Error parseando segmentos de la URL:", e);
          }
        }
        
        // 2. Si no hay en la URL, intentar leer de sessionStorage
        if (!segments) {
          const segmentsStr = sessionStorage.getItem("discSegments");
          if (segmentsStr) {
            try {
              segments = JSON.parse(segmentsStr);
              console.log("✓ Segmentos encontrados en sessionStorage:", segments);
              // Store segments globally for email functionality
              window.currentSegments = segments;
            } catch (e) {
              console.error("Error parseando segmentos de sessionStorage:", e);
            }
          }
        }
        
        // 3. Si no hay en sessionStorage, intentar leer de localStorage
        if (!segments) {
          const segmentsStr = localStorage.getItem("discSegments");
          if (segmentsStr) {
            try {
              segments = JSON.parse(segmentsStr);
              console.log("✓ Segmentos encontrados en localStorage:", segments);
              // Store segments globally for email functionality
              window.currentSegments = segments;
            } catch (e) {
              console.error("Error parseando segmentos de localStorage:", e);
            }
          }
        }

        // 4. Si no hay segmentos guardados, intentar calcularlos desde los resultados
        if (!segments) {
          console.log("No hay segmentos guardados, calculando desde resultados...");
          
          // Intentar obtener resultados de la URL
          const resultsParam = urlParams.get("results");
          if (resultsParam) {
            try {
              const results = JSON.parse(decodeURIComponent(resultsParam));
              console.log("Resultados obtenidos de la URL:", results);
              // Guardar en localStorage
              try {
                localStorage.setItem("discResults", JSON.stringify(results));
                sessionStorage.setItem("discResults", JSON.stringify(results));
              } catch (e) {
                console.warn("No se pudieron guardar los resultados:", e);
              }
            } catch (e) {
              console.error("Error parseando resultados de la URL:", e);
            }
          }
          
          segments = calculateSegmentsFromResults();
          if (segments) {
            console.log("✓ Segmentos calculados exitosamente:", segments);
            // Store segments globally for email functionality
            window.currentSegments = segments;
            // Guardar los segmentos calculados para futuras referencias
            try {
              localStorage.setItem("discSegments", JSON.stringify(segments));
              sessionStorage.setItem("discSegments", JSON.stringify(segments));
            } catch (e) {
              console.warn("No se pudieron guardar los segmentos calculados:", e);
            }
          } else {
            console.error("✗ No se pudieron calcular los segmentos desde los resultados");
            // Verificar qué hay en localStorage
            console.log("Contenido de localStorage:");
            console.log("  discResults:", localStorage.getItem("discResults"));
            console.log("  discSegments:", localStorage.getItem("discSegments"));
            console.log("  discDisplayScores:", localStorage.getItem("discDisplayScores"));
            console.log("Contenido de sessionStorage:");
            console.log("  discResults:", sessionStorage.getItem("discResults"));
            console.log("  discSegments:", sessionStorage.getItem("discSegments"));
          }
        }

        if (!segments) {
          throw new Error("No se pudieron obtener los segmentos. Por favor, complete el test nuevamente.");
        }
        
        // Formar el código de 4 dígitos: D, I, S, C
        const code = `${segments.D}${segments.I}${segments.S}${segments.C}`;
        
        console.log("Buscando patrón con código:", code);
        console.log("Segmentos:", segments);

        // Store segments globally for email functionality
        window.currentSegments = segments;

        // Buscar el patrón
        const patron = findPatronByCode(code);
        
        // Store patron data globally for email functionality
        if (patron) {
          window.currentPatronData = patron;
        }
        
        if (!patron) {
          // Si no se encuentra, mostrar un mensaje de error más amigable
          const container = document.querySelector(".container");
          container.innerHTML = `
            <h1>Patrón no encontrado</h1>
            <p>No se encontró un patrón para el código <code>${code}</code>.</p>
            <div class="meta">
              <p><strong>Segmentos obtenidos:</strong></p>
              <p>D: ${segments.D}, I: ${segments.I}, S: ${segments.S}, C: ${segments.C}</p>
              <p><strong>Código formado:</strong> ${code}</p>
              <p><strong>Total de patrones disponibles:</strong> ${window.patrones ? window.patrones.length : 0}</p>
            </div>
            <p style="margin-top: 20px;">
              <a href="index.html" style="color: #5fa890; text-decoration: underline;">Volver al test</a>
            </p>
          `;
          return;
        }

        // Renderizar el patrón encontrado
        console.log("Patrón encontrado:", patron.nombre);
        
        // Mapear los campos del patrón a los elementos del DOM
        const fieldMapping = {
          nombre: "nombre",
          emociones: "emociones",
          meta: "meta",
          juzga_a_los_demas_por: "juzga_a_los_demas_por",
          influye_en_los_demas_mediante: "influye_en_los_demas_mediante",
          valor_para_la_organizacion: "valor_para_la_organizacion",
          abusa_de: "abusa_de",
          bajo_presion: "bajo_presion",
          teme: "teme",
          seria_mas_eficaz_si: "seria_mas_eficaz_si",
          descripcion: "descripcion",
          nivel_onboarding: "nivel_onboarding",
          aprendizajes_esperados: "aprendizajes_esperados"
        };

        for (const [key, elementId] of Object.entries(fieldMapping)) {
          const el = document.getElementById(elementId);
          if (el && patron[key] !== undefined) {
            el.textContent = patron[key];
          }
        }

      } catch (error) {
        console.error("Error al cargar el patrón:", error);
        const container = document.querySelector(".container");
        container.innerHTML = `
          <h1>Error al cargar el patrón</h1>
          <p>${error.message || "Ocurrió un error al procesar los resultados del test."}</p>
          <p style="margin-top: 20px;">
            <a href="index.html" style="color: #5fa890; text-decoration: underline;">Volver al test</a>
          </p>
        `;
      }
    }

    // Cargar el patrón cuando la página esté lista
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadPatron);
    } else {
      loadPatron();
    }

    // EmailJS Configuration
    // TODO: Replace these with your actual EmailJS credentials
    // Get them from https://www.emailjs.com/
    const EMAILJS_SERVICE_ID = 'service_25dq11k'; // Replace with your EmailJS service ID
    const EMAILJS_TEMPLATE_ID = 'template_toa9xet'; // Replace with your EmailJS template ID
    const EMAILJS_PUBLIC_KEY = 'ESxmjvGP_bv4tcBkc'; // Replace with your EmailJS public key

    // Initialize EmailJS
    (function() {
      emailjs.init(EMAILJS_PUBLIC_KEY);
    })();

    // Store patron data globally for email sending (will be set by loadPatron)
    window.currentPatronData = null;
    window.currentSegments = null;

    // Function to format patron data for email
    function formatPatronForEmail(patron, segments) {
      if (!patron) return '';
      
      let emailContent = `
RESULTADOS DEL TEST DISC

Patrón: ${patron.nombre || 'N/A'}

Descripción:
${patron.descripcion || 'N/A'}

Nivel de Onboarding:
${patron.nivel_onboarding || 'N/A'}

Aprendizajes esperados:
${patron.aprendizajes_esperados || 'N/A'}

---
Segmentos DISC: D=${segments?.D || 'N/A'}, I=${segments?.I || 'N/A'}, S=${segments?.S || 'N/A'}, C=${segments?.C || 'N/A'}
Código: ${segments ? `${segments.D}${segments.I}${segments.S}${segments.C}` : 'N/A'}
      `;

      // Add additional fields if they exist
      if (patron.emociones) {
        emailContent += `\n\nEmociones:\n${patron.emociones}`;
      }
      if (patron.meta) {
        emailContent += `\n\nMeta:\n${patron.meta}`;
      }
      if (patron.valor_para_la_organizacion) {
        emailContent += `\n\nValor para la organización:\n${patron.valor_para_la_organizacion}`;
      }

      return emailContent.trim();
    }

    // Function to send email via EmailJS
    async function sendEmail(email, patron, segments) {
      try {
        const templateParams = {
          email: email,
          patron_name: patron.nombre || 'N/A',
          patron_description: patron.descripcion || 'N/A',
          nivel_onboarding: patron.nivel_onboarding || 'N/A',
          aprendizajes_esperados: patron.aprendizajes_esperados || 'N/A',
          full_content: formatPatronForEmail(patron, segments),
          segments: segments ? `D: ${segments.D}, I: ${segments.I}, S: ${segments.S}, C: ${segments.C}` : 'N/A',
          code: segments ? `${segments.D}${segments.I}${segments.S}${segments.C}` : 'N/A'
        };

        const response = await emailjs.send(
          EMAILJS_SERVICE_ID,
          EMAILJS_TEMPLATE_ID,
          templateParams
        );

        return { success: true, response };
      } catch (error) {
        console.error('Error sending email:', error);
        return { success: false, error };
      }
    }

    // Handle form submission
    document.addEventListener('DOMContentLoaded', function() {
      const emailForm = document.getElementById('emailForm');
      const sendBtn = document.getElementById('sendBtn');
      const messageDiv = document.getElementById('message');

      if (emailForm) {
        emailForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const emailInput = document.getElementById('userEmail');
          const email = emailInput.value.trim();

          if (!email) {
            showMessage('Por favor, ingresa un correo electrónico válido.', 'error');
            return;
          }

          // Validate email format
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email)) {
            showMessage('Por favor, ingresa un correo electrónico válido.', 'error');
            return;
          }

          // Check if patron data is available
          if (!window.currentPatronData) {
            showMessage('Error: No se encontraron los datos del patrón. Por favor, recarga la página.', 'error');
            return;
          }

          // Disable button and show loading state
          sendBtn.disabled = true;
          sendBtn.textContent = 'Enviando...';
          hideMessage();

          // Send email
          const result = await sendEmail(email, window.currentPatronData, window.currentSegments);

          // Re-enable button
          sendBtn.disabled = false;
          sendBtn.textContent = 'Enviar resultados por correo';

          if (result.success) {
            showMessage('¡Éxito! Los resultados han sido enviados a tu correo electrónico.', 'success');
            emailInput.value = ''; // Clear the input
          } else {
            showMessage('Error al enviar el correo. Por favor, verifica tu conexión e intenta nuevamente.', 'error');
            console.error('EmailJS error:', result.error);
          }
        });
      }
    });

    // Helper functions for messages
    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      if (messageDiv) {
        messageDiv.textContent = text;
        messageDiv.className = `message ${type}`;
      }
    }

    function hideMessage() {
      const messageDiv = document.getElementById('message');
      if (messageDiv) {
        messageDiv.className = 'message';
      }
    }

  </script>
</body>
</html>
